name: Build TEST

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
  release:
    types:
      - created

jobs:
  build_macos:
    runs-on: macos-latest

    steps:
      - name: Cleanup iOS Simulators
        run: |
          df -h
          rm -rf /private/var/folders/py/lcjn3y352g1106vf1rqk521r0000gn/T/t-G7ouNl/0.dmg
          echo "Removing large simulator runtime .dmg files..."
          find /Users/runner/ -type f -name "*.dmg" -exec rm -f {} \;
          find /private/tmp/ -type f -name "*.dmg" -exec rm -f {} \;
          sudo find /System/Volumes/Data/System/Library/AssetsV2/ -type f -name "*.dmg" -exec rm -f {} \;
          sudo find /System/Volumes/Data/Library/Developer/CoreSimulator/ -name "*.dmg" -exec rm -f {} \;
          echo "Shutting down all simulators..."
          xcrun simctl shutdown all
          xcrun simctl delete all
          df -h
          # sudo find /System/Volumes/Data -type f -size +500M -exec du -h {} + 2>/dev/null | sort -rh | head -n 10

      - name: Check out Git repository
        uses: actions/checkout@v3

      - name: Install Node.js, NPM and Yarn
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install
        run: npm install

      - name: Test
        run: npm run test

      - name: Build and Release MacOS (dmg)
        # if: ${{github.ref == 'refs/heads/main'}}
        env:
          GITHUB_TOKEN: ${{secrets.github_token}}
          CSC_LINK: ${{secrets.MACOS_CSC_LINK}}
          CSC_KEY_PASSWORD: ${{secrets.MACOS_CSC_KEY_PASSWORD}}
          EP_PRE_RELEASE: true
          DEBUG: electron-builder
        run: |
          df -h
          npm run publish
          df -h
